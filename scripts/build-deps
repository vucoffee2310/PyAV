#! /usr/bin/env bash

# --- AUTOMATIC CONFIGURATION START ---
# 1. Determine the absolute path to the project root (one level up from 'scripts/')
export PYAV_ROOT="$(cd "$(dirname "${BASH_SOURCE[0]}")/.."; pwd)"

# 2. Hardcode the FFmpeg version (Must match what you put in setup.py)
export PYAV_LIBRARY="ffmpeg-8.0"

# 3. Define the directory structure for the vendor build
export PYAV_LIBRARY_ROOT="$PYAV_ROOT/vendor"
export PYAV_LIBRARY_BUILD="$PYAV_LIBRARY_ROOT/build"
export PYAV_LIBRARY_PREFIX="$PYAV_LIBRARY_BUILD/$PYAV_LIBRARY"

# 4. Mark environment as activated
export _PYAV_ACTIVATED=1
# --- AUTOMATIC CONFIGURATION END ---

cd "$PYAV_ROOT"

# Skip the build if the binary already exists
if [[ -e "$PYAV_LIBRARY_PREFIX/bin/ffmpeg" ]]; then
    echo "We have a cached build of $PYAV_LIBRARY in $PYAV_LIBRARY_PREFIX; skipping re-build."
    exit 0
fi

echo "Building $PYAV_LIBRARY in $PYAV_LIBRARY_PREFIX..."

mkdir -p "$PYAV_LIBRARY_ROOT"
mkdir -p "$PYAV_LIBRARY_PREFIX"

cd "$PYAV_LIBRARY_ROOT"

# Download and expand the source if needed
if [[ ! -d $PYAV_LIBRARY ]]; then
    url="https://ffmpeg.org/releases/$PYAV_LIBRARY.tar.gz"
    echo "Downloading $url..."
    curl "$url" --output ${PYAV_LIBRARY}.tar.gz || exit 1
    tar -xzf $PYAV_LIBRARY.tar.gz
    rm $PYAV_LIBRARY.tar.gz
    echo "Extracted to $(pwd)/$PYAV_LIBRARY"
fi
cd $PYAV_LIBRARY

echo "Configuring FFmpeg (Audio Only)..."
# AUDIO ONLY CONFIGURATION
# Added --disable-x86asm to fix build error on systems without NASM installed.
./configure \
    --prefix="$PYAV_LIBRARY_PREFIX" \
    --disable-doc \
    --disable-static \
    --disable-stripping \
    --disable-libxml2 \
    --enable-shared \
    --enable-gpl \
    --enable-version3 \
    --disable-network \
    --disable-hwaccels \
    --disable-libx264 \
    --disable-debug \
    --disable-x86asm \
    --enable-optimizations \
    || exit 2
echo

echo "Running Make..."
make -j4 || exit 3
echo

echo "Installing..."
make install || exit 4
echo

echo "Build complete. Libraries located at:"
find "$PYAV_LIBRARY_PREFIX" -name '*libav*' | head -n 5
echo "..."
